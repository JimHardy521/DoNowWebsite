<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Full Screen Practice</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="common.js"></script>

<style>
body {
  font-family: 'Inter', sans-serif;
  margin: 0;
  padding: 20px;
  background-color: #f0f4f8;
  overflow: hidden;
}

h1 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 1.4rem;
}

/* 4 x 3 grid */
#questions {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(4, 1fr);
  gap: 12px;
  height: calc(100vh - 120px);
  font-size: 1rem; /* JS will control this */
}

.question-box {
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 12px;
  background: #f9f9f9;
  cursor: pointer;
  display: flex;
  align-items: flex-start;
  overflow: hidden;
}

.question-box.revealed {
  border: 2px solid #22c55e;
  background: #f0fdf4;
}

.question-box:hover {
  background: #eef3f8;
}

.question-table {
  width: 100%;
  border-collapse: collapse;
}

.question-table td {
  vertical-align: top;
  padding: 2px 6px;
}

.qnum {
  width: 32px;
  font-weight: 600;
}
</style>
</head>

<body>

<h1 id="title">Practice</h1>
<div id="questions"></div>

<script>
// ---------------- URL PARAMETERS ----------------
const params = new URLSearchParams(window.location.search);
const topic = params.get("topic");
const source = params.get("source");
const year = params.get("year");

let questionsArray;

// ---------------- LOAD QUESTION FILE ----------------
function loadQuestionsJS(callback) {
  const map = {
    l2further: "l2furtherquestions.js",
    gcse: "gcseQuestions.js",
    alevel: "alevelquestions.js",
    alevelfurther: "alevelfurther.js"
  };
  const script = document.createElement("script");
  script.src = map[source];
  script.onload = callback;
  document.head.appendChild(script);
}

// ---------------- BUILD PAGE ----------------
function buildPage() {

  questionsArray =
    source === "l2further" ? l2FurtherQuestions :
    source === "gcse" ? gcseQuestions :
    source === "alevel" ? alevelQuestions :
    source === "alevelfurther" ? alevelfurther :
    [];

  let filtered = questionsArray.filter(q => q.topic === topic);

  if (year && (source === "alevel" || source === "alevelfurther")) {
    filtered = filtered.filter(q => q.level === year);
  }

  const pageTitle = `Practice: ${topic}` + (year ? ` (${year})` : "");
  document.getElementById("title").textContent = pageTitle;

  const container = document.getElementById("questions");
  container.innerHTML = "";

  filtered.sort(() => Math.random() - 0.5);

  filtered.slice(0, 12).forEach((q, i) => {

    const box = document.createElement("div");
    box.className = "question-box";

    let showingSolution = false;

    function render() {
      box.innerHTML = `
        <table class="question-table">
          <tr>
            <td class="qnum">${i + 1}.</td>
            <td>${showingSolution ? q.solution : q.question}</td>
          </tr>
        </table>
      `;
      MathJax.typesetPromise([box]).then(() => {
        maximiseFontSize();
      });
    }

    box.onclick = () => {
      showingSolution = !showingSolution;
      box.classList.toggle("revealed");
      render();
    };

    container.appendChild(box);
    render();
  });

  MathJax.typesetPromise().then(() => {
    maximiseFontSize();
  });
}

// ---------------- SMART FONT MAXIMISER ----------------
function maximiseFontSize() {
  const container = document.getElementById("questions");
  const boxes = document.querySelectorAll(".question-box");

  let fontSize = 1.2;
  container.style.fontSize = fontSize + "rem";

  const boxHeight = boxes[0].clientHeight;

  // Increase until any box overflows
  while (fontSize < 3) {
    container.style.fontSize = fontSize + 0.05 + "rem";

    let overflow = false;

    boxes.forEach(box => {
      if (box.scrollHeight > box.clientHeight) {
        overflow = true;
      }
    });

    if (overflow) break;

    fontSize += 0.05;
  }

  container.style.fontSize = fontSize + "rem";
}

window.addEventListener("resize", maximiseFontSize);

loadQuestionsJS(buildPage);
</script>

</body>
</html>
