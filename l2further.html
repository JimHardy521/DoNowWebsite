<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Level 2 Further Maths â€“ Do Now</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="l2furtherquestions.js"></script>
<script src="common.js"></script>

<style>
body {
  font-family: 'Inter', sans-serif;
  margin: 0;
  background-color: #f0f4f8;
  color: #333;
}
</style>
</head>

<body>

<h1>Level 2 Further Maths â€“ Do Now</h1>

<div class="button-bar">
  <button onclick="loadL2FurtherQuestions()">New Questions</button>
  <button onclick="printL2FurtherQuestions()">Print Questions</button>
</div>

<div id="questions"></div>

<div style="text-align:center; margin:12px 0; font-size:14px;">
  <label style="cursor:pointer;">
    Click on each question to reveal the solution, or tick here to reveal all
    <input
      type="checkbox"
      id="revealAll"
      onchange="toggleAllSolutions(this.checked)"
      style="margin-left:6px;"
    >
  </label>
</div>

<hr>

<p style="text-align:center;font-weight:700;">
  â€¦ or create a Do Now using specific topics:
</p>

<div class="topic-toolbar">
  <div class="topic-wrapper">
    <label>Question 1 Topic</label>
    <select id="topic1"></select>
  </div>
  <div class="topic-wrapper">
    <label>Question 2 Topic</label>
    <select id="topic2"></select>
  </div>
  <div class="topic-wrapper">
    <label>Question 3 Topic</label>
    <select id="topic3"></select>
  </div>
  <div class="topic-wrapper">
    <label>Question 4 Topic</label>
    <select id="topic4"></select>
  </div>
  <div class="topic-wrapper">
    <button onclick="loadL2FurtherTopicQuestions()">Load Topic Questions</button>
    <button onclick="copyTopicURL()">Copy Topic Link</button>
  </div>
</div>

<script>
// ---------- UTIL ----------
function randomFrom(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

// ---------- TOPICS ----------
function populateTopicsL2Further() {
  const topics = [...new Set(l2FurtherQuestions.map(q => q.topic))]
    .sort((a, b) => a.localeCompare(b));

  ["topic1", "topic2", "topic3", "topic4"].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = "";
    topics.forEach(t => {
      const o = document.createElement("option");
      o.value = t;
      o.textContent = t;
      sel.appendChild(o);
    });
  });
}

// ---------- QUESTION BOX ----------
function createBoxL2Further(q, index) {
  const box = document.createElement("div");
  box.className = "question-box";
  box.dataset.topic = q.topic;

  const h = document.createElement("div");
  h.className = "question-header";
  h.innerHTML = `Question ${index + 1}: ${q.topic}`;
  box.appendChild(h);

  const qt = document.createElement("div");
  qt.innerHTML = q.question;
  box.appendChild(qt);

  const sol = document.createElement("div");
  sol.className = "solution";
  sol.style.display = "none";
  sol.innerHTML = `<strong>Solution:</strong> ${q.solution}`;
  box.appendChild(sol);

  box.onclick = () => {
    sol.style.display = sol.style.display === "none" ? "block" : "none";
  };

  // ðŸ”€ Any-topic refresh
  const rAny = document.createElement("div");
  rAny.className = "refresh-btn";
  rAny.innerHTML = "â†»";
  rAny.title = "New random question";
  rAny.onclick = e => {
    e.stopPropagation();
    let nq;
    do {
      nq = randomFrom(l2FurtherQuestions);
    } while (nq.question === qt.innerHTML && l2FurtherQuestions.length > 1);

    qt.innerHTML = nq.question;
    sol.innerHTML = `<strong>Solution:</strong> ${nq.solution}`;
    h.innerHTML = `Question ${index + 1}: ${nq.topic}`;
    box.dataset.topic = nq.topic;

    MathJax.typeset();
  };
  box.appendChild(rAny);

  // ðŸ” Same-topic refresh
  const rSame = document.createElement("div");
  rSame.className = "refresh-btn refresh-same";
  rSame.innerHTML = "â†º";
  rSame.title = "New question from same topic";
  rSame.onclick = e => {
    e.stopPropagation();

    const topic = box.dataset.topic;
    const pool = l2FurtherQuestions.filter(q => q.topic === topic);
    if (pool.length < 2) return;

    let nq;
    do {
      nq = randomFrom(pool);
    } while (nq.question === qt.innerHTML);

    qt.innerHTML = nq.question;
    sol.innerHTML = `<strong>Solution:</strong> ${nq.solution}`;
    h.innerHTML = `Question ${index + 1}: ${nq.topic}`;
    box.dataset.topic = nq.topic;

    MathJax.typeset();
  };
  box.appendChild(rSame);

  document.getElementById("questions").appendChild(box);

  // Practice topic button
  const practiceBtn = document.createElement("div");
  practiceBtn.className = "refresh-btn practice-topic";
  practiceBtn.innerHTML = "âž¤";
  practiceBtn.title = "Practice this topic further";

  practiceBtn.onclick = e => {
    e.stopPropagation();

    const topic = box.dataset.topic;

    // Open a new window with the topic parameter
    const url = `practice.html?topic=${encodeURIComponent(topic)}&source=l2further`;
    window.open(url, "_blank");
  };

  box.appendChild(practiceBtn);


}

// ---------- LOAD RANDOM ----------
function loadL2FurtherQuestions() {
  document.getElementById("questions").innerHTML = "";
  document.getElementById("revealAll").checked = false;

  for (let i = 0; i < 4; i++) {
    createBoxL2Further(randomFrom(l2FurtherQuestions), i);
  }

  MathJax.typeset();
}

// ---------- LOAD BY TOPIC ----------
function loadL2FurtherTopicQuestions() {
  document.getElementById("questions").innerHTML = "";
  document.getElementById("revealAll").checked = false;

  ["topic1", "topic2", "topic3", "topic4"].forEach((id, i) => {
    const topic = document.getElementById(id).value;
    const filtered = l2FurtherQuestions.filter(q => q.topic === topic);
    if (filtered.length) {
      createBoxL2Further(randomFrom(filtered), i);
    }
  });

  MathJax.typeset();
}

// ---------- REVEAL ALL ----------
function toggleAllSolutions(show) {
  document.querySelectorAll(".solution").forEach(sol => {
    sol.style.display = show ? "block" : "none";
  });
}

// ---------- COPY TOPIC LINK ----------
function copyTopicURL() {
  const params = new URLSearchParams({
    t1: topic1.value,
    t2: topic2.value,
    t3: topic3.value,
    t4: topic4.value
  });

  const url =
    window.location.origin +
    window.location.pathname +
    "?" +
    params.toString();

  navigator.clipboard.writeText(url).then(() => {
    alert("Topic link copied to clipboard. Paste this into a new window to get these same topics to practice");
  });
}

// ---------- LOAD FROM URL ----------
function loadFromURLIfPresent() {
  const params = new URLSearchParams(window.location.search);
  let used = false;

  ["topic1", "topic2", "topic3", "topic4"].forEach((id, i) => {
    const val = params.get(`t${i + 1}`);
    const sel = document.getElementById(id);

    if (val && [...sel.options].some(o => o.value === val)) {
      sel.value = val;
      used = true;
    }
  });

  if (used) loadL2FurtherTopicQuestions();
}

// ---------- PRINT ----------
function printL2FurtherQuestions() {
  const boxes = document.querySelectorAll(".question-box");
  let questions = [];

  boxes.forEach(b => {
    questions.push({
      header: b.querySelector(".question-header").innerHTML,
      question: b.children[1].innerHTML
    });
  });

  // duplicate for cut-and-fold
  questions = questions.concat(questions);

  const win = window.open("", "_blank");
  win.document.write(`
  <html>
  <head>
    <style>
      @page { size: A4; margin: 5mm; }
      body { font-family: Inter, Arial, sans-serif; margin: 0; }
      .page {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .box {
        border: 1px solid black;
        padding: 8px;
        font-size: 14px;
        min-height: 190px;
      }
      .cut { border-top: 2px dashed black; margin: 10px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
  </head>
  <body>
    <div class="page">
      ${questions.slice(0,4).map(q =>
        `<div class="box"><strong>${q.header}</strong><br>${q.question}</div>`
      ).join("")}
    </div>
    <div class="cut"></div>
    <div class="page">
      ${questions.slice(4,8).map(q =>
        `<div class="box"><strong>${q.header}</strong><br>${q.question}</div>`
      ).join("")}
    </div>
  </body>
  </html>
  `);
  win.document.close();
  win.onload = () => win.MathJax.typesetPromise().then(() => win.print());
}

// ---------- INIT ----------
populateTopicsL2Further();

if (window.location.search) {
  loadFromURLIfPresent();
} else {
  loadL2FurtherQuestions();
}
</script>

<script>
  createNavBar("l2further.html");
</script>

</body>
</html>
