<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Create Revision Worksheet</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Inter', sans-serif;
  background:#f0f4f8;
  margin:0;
  padding:20px;
}

h1 { text-align:center; }

table {
  width:100%;
  max-width:760px;
  margin:20px auto;
  border-collapse:collapse;
  background:white;
}

th, td {
  padding:10px 12px;
  border-bottom:1px solid #ddd;
}

th {
  background:#e9eef3;
  text-align:left;
}

/* ===== PREVIEW ICON ===== */
.preview-cell {
  text-align:center;
  position:relative;
}

.preview-icon {
  cursor:pointer;
  font-size:1.1rem;
}

.tooltip {
  display:none;
  position:absolute;
  top:50%;
  left:110%;
  transform:translateY(-50%);
  width:300px;
  background:#fff;
  border:1px solid #ccc;
  padding:10px;
  font-size:1.2rem;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
  z-index:10;
}

.preview-cell:hover .tooltip {
  display:block;
}

/* ===== CONTROLS ===== */
.actions {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:18px;
  margin-top:25px;
}

.actions-row,
.bottom-row {
  display:flex;
  align-items:center;
  gap:20px;
}

select, input[type="text"] {
  padding:6px 8px;
  font-family:inherit;
  font-size:1rem;
}

button {
  padding:8px 16px;
  font-size:1rem;
}

button:disabled {
  opacity:0.5;
  cursor:not-allowed;
}
</style>
</head>

<body>

<h1>Revision Worksheet Topics</h1>
<p style="text-align:center;font-weight:600;" id="levelHeading"></p>

<table>
  <thead>
    <tr>
      <th><input type="checkbox" id="toggleAll" checked> Include</th>
      <th>Topic</th>
      <th>Preview</th>
    </tr>
  </thead>
  <tbody id="topicTable"></tbody>
</table>

<div class="actions">
  <div class="actions-row">
    <label><strong>Number of questions:</strong></label>
    <select id="questionCount">
      <option>8</option>
      <option>12</option>
      <option>16</option>
      <option selected>20</option>
      <option>24</option>
    </select>
  </div>

  <div class="bottom-row">
    <label><strong>Title:</strong></label>
    <input type="text" id="worksheetTitle" style="width:360px;">
    <button id="generateBtn" onclick="generateWorksheet()">Generate Worksheet</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script>
function getParam(name, fallback) {
  return new URLSearchParams(location.search).get(name) || fallback;
}

const source = getParam("source", "gcse");
const level  = getParam("level", "Higher");

let questionsData = [];

/* ===== LOAD CORRECT QUESTION FILE ===== */
const script = document.createElement("script");
script.src =
  source === "alevel"        ? "alevelquestions.js" :
  source === "alevelfurther" ? "alevelfurther.js" :
  source === "l2further"     ? "l2furtherquestions.js" :
                               "gcseQuestions.js";

script.onload = () => {
  questionsData =
    source === "alevel"        ? alevelQuestions :
    source === "alevelfurther" ? alevelfurther :
    source === "l2further"     ? l2FurtherQuestions :
                                 gcseQuestions;
  buildTopicTable();
};

document.head.appendChild(script);

/* ===== BUILD TOPIC TABLE ===== */
function buildTopicTable() {

  levelHeading.textContent =
    source === "l2further"
      ? "Level 2 Further Maths"
      : source === "alevelfurther"
        ? `A Level Further Maths ‚Äì ${level}`
        : `Level: ${level}`;

  worksheetTitle.value =
    source === "alevel"
      ? `A Level Maths ‚Äì ${level} Revision Worksheet`
      : source === "alevelfurther"
        ? `A Level Further Maths ‚Äì ${level} Revision Worksheet`
        : source === "l2further"
          ? "Level 2 Further Maths ‚Äì Revision Worksheet"
          : "GCSE Maths ‚Äì Revision Worksheet";

  const topics = [...new Set(
    questionsData
      .filter(q => source === "l2further" || q.level === level)
      .map(q => q.topic)
  )].sort();

  topicTable.innerHTML = "";

  topics.forEach(t => {
    const example =
      questionsData.find(q => q.topic === t)?.question || "";

    topicTable.insertAdjacentHTML("beforeend", `
      <tr>
        <td><input type="checkbox" checked data-topic="${t}" onchange="updateState()"></td>
        <td>${t}</td>
        <td class="preview-cell">
          <span class="preview-icon">üëÅÔ∏è</span>
          <div class="tooltip">${example}</div>
        </td>
      </tr>
    `);
  });

  toggleAll.onchange = () => {
    document.querySelectorAll("#topicTable input")
      .forEach(cb => cb.checked = toggleAll.checked);
    updateState();
  };

  updateState();

  if (window.MathJax) {
    MathJax.typesetPromise();
  }
}

/* ===== UI STATE ===== */
function updateState() {
  const boxes = [...document.querySelectorAll("#topicTable input")];
  generateBtn.disabled = !boxes.some(cb => cb.checked);
  toggleAll.checked = boxes.every(cb => cb.checked);
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/* ===== GENERATE WORKSHEET ===== */
function generateWorksheet() {

  const total = +questionCount.value;
  const title = worksheetTitle.value.trim();

  let topics = [...document.querySelectorAll("#topicTable input:checked")]
    .map(cb => cb.dataset.topic);

  topics = shuffle(topics);

  if (topics.length > total) {
    topics = topics.slice(0, total);
  }

  const pools = {};
  topics.forEach(topic => {
    pools[topic] = shuffle(
      questionsData.filter(q =>
        q.topic === topic &&
        (source === "l2further" || q.level === level)
      )
    );
  });

  const base = Math.floor(total / topics.length);
  let selected = [];

  topics.forEach(topic => {
    selected = selected.concat(pools[topic].splice(0, base));
  });

  while (selected.length < total) {
    for (const topic of topics) {
      if (selected.length >= total) break;
      if (pools[topic].length) selected.push(pools[topic].shift());
    }
  }

  selected = shuffle(selected);

  const win = window.open("", "_blank");

  win.document.write(`
<html>
<head>
<title>${title}</title>
<style>
@page { size:A4; margin:12mm; }

body {
  font-family: Inter, Arial;
  font-size: 12pt;
  line-height: 1.6;
}

.print-header {
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin-bottom:16px;
  border-bottom:2px solid #000;
  padding-bottom:6px;
}

.print-brand {
  font-size:14pt;
  font-weight:700;
}

.print-meta {
  font-size:10pt;
  text-align:right;
}

.print-meta span {
  display:inline-block;
  min-width:160px;
  border-bottom:1px solid #000;
  margin-left:6px;
}

.print-title {
  font-size:14pt;
  font-weight:700;
  text-align:center;
  margin:18px 0;
}

.print-table {
  width:100%;
  border-collapse:collapse;
}

.print-table td {
  vertical-align:top;
  padding:6px 4px;
}

.print-qnum {
  width:28px;
  font-weight:700;
}

.print-answers {
  page-break-before:always;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
</head>

<body>

<div class="print-header">
  <div class="print-brand">mrhardymaths</div>
  <div class="print-meta">
    <div>Name:<span></span></div>
    <div>Date:<span></span></div>
  </div>
</div>

<div class="print-title">${title}</div>

<table class="print-table">
${selected.map((q,i)=>`
<tr>
  <td class="print-qnum">${i+1}.</td>
  <td>${q.question}</td>
</tr>
`).join("")}
</table>

<div class="print-answers">
  <div class="print-title">${title} ‚Äì Answers</div>
  <table class="print-table">
  ${selected.map((q,i)=>`
    <tr>
      <td class="print-qnum">${i+1}.</td>
      <td>${q.solution}</td>
    </tr>
  `).join("")}
  </table>
</div>

</body>
</html>
  `);

  win.document.close();
  win.onload = () => win.MathJax.typesetPromise().then(()=>win.print());
}
</script>

</body>
</html>
