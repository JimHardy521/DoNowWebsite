<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Create Revision Worksheet</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Inter', sans-serif;
  background:#f0f4f8;
  margin:0;
  padding:20px;
}

h1 {
  text-align:center;
}

table {
  width:100%;
  max-width:720px;
  margin:20px auto;
  border-collapse:collapse;
  background:white;
}

th, td {
  padding:10px 12px;
  border-bottom:1px solid #ddd;
}

th {
  background:#e9eef3;
  text-align:left;
}

.actions {
  text-align:center;
  margin-top:25px;
}

select, input[type="text"] {
  padding:6px 8px;
  font-family:inherit;
  font-size:1rem;
}

button {
  padding:8px 14px;
  font-size:1rem;
}

button:disabled {
  opacity:0.5;
  cursor:not-allowed;
}
</style>
</head>

<body>

<h1>Revision Worksheet Topics</h1>
<p style="text-align:center;font-weight:600;" id="levelHeading"></p>

<table>
  <thead>
    <tr>
      <th>
        <input type="checkbox" id="toggleAll" checked>
        Include
      </th>
      <th>Topic</th>
    </tr>
  </thead>
  <tbody id="topicTable"></tbody>
</table>

<div class="actions">
  <label style="font-weight:600; margin-right:6px;">Title:</label>
  <input type="text" id="worksheetTitle" style="width:280px;">

  <br><br>

  <label style="font-weight:600; margin-right:6px;">
    Number of questions:
  </label>

  <select id="questionCount">
    <option value="8">8</option>
    <option value="12">12</option>
    <option value="16">16</option>
    <option value="20" selected>20</option>
    <option value="24">24</option>
    <option value="28">28</option>
  </select>

  <br><br>

  <button id="generateBtn" onclick="generateWorksheet()">
    Generate Worksheet
  </button>
</div>

<script>
// ---------------- UTIL ----------------
function getLevelFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("level") || "Higher";
}

function getSourceFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("source") || "gcse";
}

function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

// ---------------- GLOBAL QUESTIONS ----------------
let questionsData;

// Dynamically load the correct JS file if needed
const source = getSourceFromURL();
if (source === "l2further") {
  const script = document.createElement("script");
  script.src = "l2furtherquestions.js";
  script.onload = () => {
    questionsData = l2FurtherQuestions;
    buildTopicTable();
  };
  document.head.appendChild(script);
} else {
  const script = document.createElement("script");
  script.src = "gcseQuestions.js";
  script.onload = () => {
    questionsData = gcseQuestions;
    buildTopicTable();
  };
  document.head.appendChild(script);
}

// ---------------- BUILD TABLE ----------------
function buildTopicTable() {
  if (!questionsData) return;

  const level = getLevelFromURL();
  document.getElementById("levelHeading").textContent =
    `Level: ${level}`;

  document.getElementById("worksheetTitle").value =
    source === "l2further" ? "Level 2 Further Maths – Revision Worksheet"
                            : "GCSE Maths – Revision Worksheet";

  const topics = [...new Set(
    questionsData
      .filter(q => q.level === level || source === "l2further") // l2further may not have level field
      .map(q => q.topic)
  )].sort((a,b)=>a.localeCompare(b));

  const tbody = document.getElementById("topicTable");
  tbody.innerHTML = "";

  topics.forEach(topic => {
    const row = document.createElement("tr");

    const cbCell = document.createElement("td");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = true;
    cb.dataset.topic = topic;
    cb.onchange = updateState;
    cbCell.appendChild(cb);

    const topicCell = document.createElement("td");
    topicCell.textContent = topic;

    row.appendChild(cbCell);
    row.appendChild(topicCell);
    tbody.appendChild(row);
  });

  document.getElementById("toggleAll").onchange = toggleAllTopics;
  updateState();
}

// ---------------- TOGGLE ALL ----------------
function toggleAllTopics() {
  const state = document.getElementById("toggleAll").checked;
  document.querySelectorAll("#topicTable input[type='checkbox']")
    .forEach(cb => cb.checked = state);
  updateState();
}

// ---------------- STATE UPDATE ----------------
function updateState() {
  const boxes = document.querySelectorAll("#topicTable input[type='checkbox']");
  const checked = [...boxes].filter(cb => cb.checked);

  document.getElementById("toggleAll").checked =
    checked.length === boxes.length;

  document.getElementById("generateBtn").disabled =
    checked.length === 0;
}

// ---------------- GENERATE ----------------
function generateWorksheet() {
  const level = getLevelFromURL();
  const total = parseInt(document.getElementById("questionCount").value);
  const title =
    document.getElementById("worksheetTitle").value.trim() ||
    (source === "l2further" ? "Level 2 Further Maths – Revision Worksheet" 
                             : "GCSE Maths – Revision Worksheet");

  const topics = [...document.querySelectorAll(
    "#topicTable input[type='checkbox']:checked"
  )].map(cb => cb.dataset.topic);

  if (topics.length === 0) return;

  const pools = {};
  topics.forEach(t => {
    pools[t] = shuffle(
      questionsData.filter(q => q.topic === t)
    );
  });

  const base = Math.floor(total / topics.length);
  let selected = [];

  topics.forEach(t => {
    selected = selected.concat(pools[t].splice(0, base));
  });

  let safety = 0;
  while (selected.length < total && safety < 1000) {
    safety++;
    for (const t of topics) {
      if (selected.length >= total) break;
      if (pools[t].length) selected.push(pools[t].shift());
    }
  }

  if (selected.length < total) {
    alert(`Only ${selected.length} questions available.`);
    return;
  }

  const win = window.open("", "_blank");

  win.document.write(`
  <html>
  <head>
    <title>${title}</title>
    <style>
      @page { size: A4; margin: 15mm; }
      body { font-family: Inter, Arial; }
      .header { display:flex; justify-content:flex-start; align-items:center; margin-bottom:10px; }
      .header span { font-size:9pt; color:#bbb; }
      h1 { text-align:center; font-size:18pt; margin:0; }
      .meta {
         margin-top: 14px;
        text-align:center;
        margin-bottom:18px;
        font-size:11pt;
      }
      .q { margin-bottom:16px; }
      .answer { margin-bottom:14px; }
      .page-break { page-break-before: always; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
  </head>
  <body>

    <div class="header">
      <span>mrhardymaths.co.uk</span>
    </div>

    <h1>${title}</h1>

    <div class="meta">
      Name: _____________________________
      &nbsp;&nbsp;&nbsp;&nbsp;
      Date: __________
    </div>

    ${selected.map((q,i)=>`
      <div class="q">
        <strong>Question ${i+1}</strong><br>
        ${q.question}
      </div>
    `).join("")}

    <div class="page-break"></div>

    <h1>${title} – Answers</h1>

    ${selected.map((q,i)=>`
      <div class="answer">
        <strong>Question ${i+1}</strong><br>
        ${q.solution}
      </div>
    `).join("")}

  </body>
  </html>
  `);

  win.document.close();
  win.onload = () =>
    win.MathJax.typesetPromise().then(() => win.print());
}

// ---------------- INIT ----------------
</script>

</body>
</html>
