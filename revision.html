<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Create Revision Worksheet</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Inter', sans-serif;
  background:#f0f4f8;
  margin:0;
  padding:20px;
}

h1 { text-align:center; }

table {
  width:100%;
  max-width:720px;
  margin:20px auto;
  border-collapse:collapse;
  background:white;
}

th, td {
  padding:10px 12px;
  border-bottom:1px solid #ddd;
}

th {
  background:#e9eef3;
  text-align:left;
}

/* ===== CONTROLS ===== */
.actions {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:18px;
  margin-top:25px;
}

.actions-row,
.bottom-row {
  display:flex;
  align-items:center;
  gap:20px;
}

select, input[type="text"] {
  padding:6px 8px;
  font-family:inherit;
  font-size:1rem;
}

button {
  padding:8px 16px;
  font-size:1rem;
}

button:disabled {
  opacity:0.5;
  cursor:not-allowed;
}
</style>
</head>

<body>

<h1>Revision Worksheet Topics</h1>
<p style="text-align:center;font-weight:600;" id="levelHeading"></p>

<table>
  <thead>
    <tr>
      <th><input type="checkbox" id="toggleAll" checked> Include</th>
      <th>Topic</th>
    </tr>
  </thead>
  <tbody id="topicTable"></tbody>
</table>

<div class="actions">

  <div class="actions-row">
    <div>
      <label><strong>Number of questions:</strong></label>
      <select id="questionCount">
        <option>8</option>
        <option>12</option>
        <option>16</option>
        <option selected>20</option>
        <option>24</option>
      </select>
    </div>

    <div>
      <label><strong>Layout:</strong></label>
      <select id="layoutMode">
        <option value="linear">Linear</option>
        <option selected value="grid">Grid (4 × 3)</option>
      </select>
    </div>
  </div>

  <div class="bottom-row">
    <label><strong>Title:</strong></label>
    <input type="text" id="worksheetTitle" style="width:360px;">
    <button id="generateBtn" onclick="generateWorksheet()">Generate Worksheet</button>
  </div>

</div>

<script>
// ---------- URL HELPERS ----------
function getParam(name, fallback) {
  return new URLSearchParams(location.search).get(name) || fallback;
}

const source = getParam("source", "gcse");
const level  = getParam("level", "Higher");

let questionsData = [];

// ---------- LOAD QUESTIONS ----------
const script = document.createElement("script");
script.src =
  source === "alevel" ? "alevelquestions.js" :
  source === "l2further" ? "l2furtherquestions.js" :
  "gcseQuestions.js";

script.onload = () => {
  questionsData =
    source === "alevel" ? alevelQuestions :
    source === "l2further" ? l2FurtherQuestions :
    gcseQuestions;
  buildTopicTable();
};
document.head.appendChild(script);

// ---------- BUILD TABLE ----------
function buildTopicTable() {
  levelHeading.textContent =
    source === "l2further" ? "Level 2 Further Maths" : `Level: ${level}`;

  worksheetTitle.value =
    source === "alevel" ? `A Level Maths – ${level} Revision Worksheet` :
    source === "l2further" ? "Level 2 Further Maths – Revision Worksheet" :
    "GCSE Maths – Revision Worksheet";

  const topics = [...new Set(
    questionsData.filter(q => source === "l2further" || q.level === level)
      .map(q => q.topic)
  )].sort();

  topicTable.innerHTML = "";
  topics.forEach(t => {
    topicTable.insertAdjacentHTML("beforeend", `
      <tr>
        <td><input type="checkbox" checked data-topic="${t}" onchange="updateState()"></td>
        <td>${t}</td>
      </tr>
    `);
  });

  toggleAll.onchange = () => {
    document.querySelectorAll("#topicTable input")
      .forEach(cb => cb.checked = toggleAll.checked);
    updateState();
  };

  updateState();
}

function updateState() {
  const boxes = [...document.querySelectorAll("#topicTable input")];
  generateBtn.disabled = !boxes.some(cb => cb.checked);
  toggleAll.checked = boxes.every(cb => cb.checked);
}

function shuffle(a){ return a.sort(()=>Math.random()-0.5); }

// ---------- GENERATE WORKSHEET ----------
function generateWorksheet() {

  const total  = +questionCount.value;
  const title  = worksheetTitle.value.trim();
  const layout = layoutMode.value;

  const topics = [...document.querySelectorAll("#topicTable input:checked")]
    .map(cb => cb.dataset.topic);

  // ---------- FAIR RANDOM SELECTION ----------
  const pools = {};
  topics.forEach(topic => {
    pools[topic] = shuffle(
      questionsData.filter(q =>
        q.topic === topic &&
        (source === "l2further" || q.level === level)
      )
    );
  });

  const base = Math.floor(total / topics.length);
  let selected = [];

  topics.forEach(topic => {
    selected = selected.concat(pools[topic].splice(0, base));
  });

  let safety = 0;
  while (selected.length < total && safety++ < 1000) {
    for (const topic of topics) {
      if (selected.length >= total) break;
      if (pools[topic].length) {
        selected.push(pools[topic].shift());
      }
    }
  }

  const win = window.open("", "_blank");

  win.document.write(`
<html>
<head>
<title>${title}</title>
<style>
@page { size: A4 ${layout==="grid"?"landscape":"portrait"}; margin:12mm; }

body { font-family:Inter,Arial; font-size:11pt; }

.page { page-break-after: always; }
.page:last-child { page-break-after: auto; }

h1 { text-align:center; margin:0 0 6mm; }

.meta { text-align:center; margin-bottom:6mm; }

/* ===== FIXED GRID ===== */
.question-grid {
  width:100%;
  height:170mm;               /* FIXED physical height */
  border-collapse:collapse;
  table-layout:fixed;
}

.question-grid tr { height: calc(170mm / 3); }

.question-grid td {
  border:2px solid #000;      /* thicker borders */
  padding:6px;
  vertical-align:top;
  overflow:hidden;
}

.cell { height:100%; overflow:hidden; }

.qnum { font-weight:600; font-size:10pt; margin-bottom:3px; }

.qtext { font-size:12pt; line-height:1.25; }
</style>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
</head>

<body>

<h1>${title}</h1>
<div class="meta">Name: _____________________________ &nbsp;&nbsp; Date: __________</div>

${
layout==="grid"
? Array.from({length: Math.ceil(selected.length/12)}, (_,p)=>`
<div class="page">
<table class="question-grid">
${
[0,1,2].map(r=>`
<tr>
${
[0,1,2,3].map(c=>{
  const i = p*12+r*4+c;
  const q = selected[i];
  return q?`
<td>
  <div class="cell">
    <div class="qnum">Q${i+1}</div>
    <div class="qtext">${q.question}</div>
  </div>
</td>`:`<td></td>`;
}).join("")}
</tr>`).join("")
}
</table>
</div>`).join("")
: selected.map((q,i)=>`
<p><strong>Question ${i+1}</strong><br>${q.question}</p>`).join("")
}

<h1 style="page-break-before:always;">${title} – Answers</h1>

${
layout === "grid"
? Array.from({length: Math.ceil(selected.length/12)}, (_,p)=>`
<div class="page">
<table class="question-grid">
${
[0,1,2].map(r=>`
<tr>
${
[0,1,2,3].map(c=>{
  const i = p*12+r*4+c;
  const q = selected[i];
  return q?`
<td>
  <div class="cell">
    <div class="qnum">Q${i+1}</div>
    <div class="qtext">${q.solution}</div>
  </div>
</td>`:`<td></td>`;
}).join("")}
</tr>`).join("")
}
</table>
</div>`).join("")
: selected.map((q,i)=>`
<p><strong>Question ${i+1}</strong><br>${q.solution}</p>`).join("")
}

</body>
</html>
  `);

  win.document.close();
  win.onload = () => win.MathJax.typesetPromise().then(()=>win.print());
}
</script>

</body>
</html>
