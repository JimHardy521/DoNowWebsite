<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Create Revision Worksheet</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="gcseQuestions.js"></script>

<style>
body {
  font-family: 'Inter', sans-serif;
  background:#f0f4f8;
  margin:0;
  padding:20px;
}

h1 {
  text-align:center;
}

table {
  width:100%;
  max-width:700px;
  margin:20px auto;
  border-collapse:collapse;
  background:white;
}

th, td {
  padding:10px 12px;
  border-bottom:1px solid #ddd;
}

th {
  background:#e9eef3;
  text-align:left;
}

tr:hover {
  background:#f7f9fc;
}

.actions {
  text-align:center;
  margin-top:25px;
}

select {
  padding:6px 8px;
  font-family:inherit;
  font-size:1rem;
}
</style>
</head>

<body>

<h1>Revision Worksheet Topics</h1>
<p style="text-align:center;font-weight:600;" id="levelHeading"></p>

<table>
  <thead>
    <tr>
      <th>Include</th>
      <th>Topic</th>
    </tr>
  </thead>
  <tbody id="topicTable"></tbody>
</table>

<div class="actions">
  <label style="font-weight:600; margin-right:8px;">
    Number of questions:
  </label>

  <select id="questionCount">
    <option value="12">12</option>
    <option value="16">16</option>
    <option value="20" selected>20</option>
    <option value="24">24</option>
    <option value="28">28</option>
    <option value="32">32</option>
  </select>

  <br><br>

  <button onclick="generateWorksheet()">Generate Worksheet</button>
</div>

<script>
function getLevelFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("level") || "Higher";
}

function buildTopicTable() {
  const level = getLevelFromURL();
  document.getElementById("levelHeading").textContent =
    `Level: ${level}`;

  const topics = [...new Set(
    gcseQuestions
      .filter(q => q.level === level)
      .map(q => q.topic)
  )].sort((a,b)=>a.localeCompare(b));

  const tbody = document.getElementById("topicTable");
  tbody.innerHTML = "";

  topics.forEach(topic => {
    const row = document.createElement("tr");

    const cbCell = document.createElement("td");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = true;
    cb.dataset.topic = topic;
    cbCell.appendChild(cb);

    const topicCell = document.createElement("td");
    topicCell.textContent = topic;

    row.appendChild(cbCell);
    row.appendChild(topicCell);
    tbody.appendChild(row);
  });
}

function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

function generateWorksheet() {
  const level = getLevelFromURL();
  const total = parseInt(document.getElementById("questionCount").value);

  const topics = [...document.querySelectorAll(
    "#topicTable input[type='checkbox']:checked"
  )].map(cb => cb.dataset.topic);

  if (topics.length === 0) {
    alert("Please select at least one topic.");
    return;
  }

  // Build pools per topic
  const pools = {};
  topics.forEach(t => {
    pools[t] = shuffle(
      gcseQuestions.filter(q => q.level === level && q.topic === t)
    );
  });

  const base = Math.floor(total / topics.length);
  let remainder = total % topics.length;

  let selected = [];

  // First pass: fair share
  topics.forEach(t => {
    const take = Math.min(base, pools[t].length);
    selected = selected.concat(pools[t].splice(0, take));
  });

  // Second pass: distribute remainder + shortages
  let safety = 0;
  while (selected.length < total && safety < 1000) {
    safety++;
    for (const t of topics) {
      if (selected.length >= total) break;
      if (pools[t].length > 0) {
        selected.push(pools[t].shift());
      }
    }
  }

  if (selected.length < total) {
    alert(
      `Only ${selected.length} questions available for the selected topics.`
    );
    return;
  }

  // Print window
  const win = window.open("", "_blank");

  win.document.write(`
  <html>
  <head>
    <title>GCSE Maths Revision Worksheet</title>
    <style>
      @page { size: A4; margin: 15mm; }
      body { font-family: Inter, Arial; }
      h1 { text-align:center; }
      .q { margin-bottom: 16px; }
      .answer { margin-bottom: 14px; }
      .page-break { page-break-before: always; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
  </head>
  <body>

    <h1>GCSE Maths â€“ Revision Worksheet</h1>

    ${selected.map((q,i)=>`
      <div class="q">
        <strong>Question ${i+1}</strong><br>
        ${q.question}
      </div>
    `).join("")}

    <div class="page-break"></div>

    <h1>Answers</h1>

    ${selected.map((q,i)=>`
      <div class="answer">
        <strong>Question ${i+1}</strong><br>
        ${q.solution}
      </div>
    `).join("")}

  </body>
  </html>
  `);

  win.document.close();
  win.onload = () =>
    win.MathJax.typesetPromise().then(() => win.print());
}

buildTopicTable();
</script>

</body>
</html>
